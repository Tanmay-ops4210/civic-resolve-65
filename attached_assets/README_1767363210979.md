# Civic Resolve Backend

Backend API for Civic Resolve - A Municipal Grievance Management System.

## Features

- ğŸ” **Authentication & Authorization**: JWT-based authentication with role-based access control (Citizen & Admin)
- ğŸ“ **Grievance Management**: Full CRUD operations for grievances with tracking IDs
- ğŸ“Š **Analytics Dashboard**: Comprehensive statistics and analytics for administrators
- ğŸ“ **File Upload**: Image upload support for grievance attachments
- ğŸ”„ **Real-time Updates**: WebSocket support for real-time status updates
- ğŸ—„ï¸ **PostgreSQL Database**: Robust database design with proper indexing
- âœ… **Input Validation**: Request validation using express-validator
- ğŸ›¡ï¸ **Security**: Helmet.js for security headers, CORS configuration

## Tech Stack

- **Runtime**: Node.js
- **Framework**: Express.js
- **Database**: PostgreSQL
- **Authentication**: JWT (JSON Web Tokens)
- **Real-time**: Socket.io
- **File Upload**: Multer
- **Validation**: express-validator

## Prerequisites

- Node.js (v14 or higher)
- PostgreSQL (v12 or higher)
- npm or yarn

## Installation

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd backend
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Set up environment variables**
   ```bash
   cp .env.example .env
   ```
   
   Edit `.env` with your configuration:
   ```env
   PORT=5001
   DB_HOST=127.0.0.1
   DB_USER=postgres
   DB_PASSWORD=your_password
   DB_NAME=civic_resolve
   JWT_SECRET=your_secret_key
   CORS_ORIGIN=http://localhost:5173
   ```

4. **Set up the database**
   ```bash
   # Connect to PostgreSQL and create database
   psql -U postgres
   CREATE DATABASE civic_resolve;
   \q
   
   # Run schema
   psql -U postgres -d civic_resolve -f database/schema.sql
   ```

5. **Create uploads directory**
   ```bash
   mkdir uploads
   ```

## Running the Application

### Development Mode
```bash
npm run dev
```

### Production Mode
```bash
npm start
```

The server will start on `http://localhost:5001` (or the port specified in `.env`).

## API Endpoints

### Authentication
- `POST /api/auth/register` - Register a new user
- `POST /api/auth/login` - Login user

### Grievances
- `POST /api/grievances` - Create a new grievance (Citizen/Admin)
- `GET /api/grievances` - Get all grievances with filters (Citizen/Admin)
- `GET /api/grievances/:id` - Get grievance by ID (Citizen/Admin)
- `GET /api/grievances/track/:trackingId` - Get grievance by tracking ID (Public)
- `PUT /api/grievances/:id` - Update grievance (Admin only)
- `DELETE /api/grievances/:id` - Delete grievance (Admin only)

### Analytics (Admin only)
- `GET /api/analytics/stats` - Get grievance statistics
- `GET /api/analytics/trends` - Get monthly trends
- `GET /api/analytics/resolution-time` - Get resolution time by category
- `GET /api/analytics/top-wards` - Get top wards by complaint count

### Health Check
- `GET /health` - Server health check

## WebSocket Events

### Client â†’ Server
- `subscribe:grievance` - Subscribe to grievance updates
- `unsubscribe:grievance` - Unsubscribe from grievance updates

### Server â†’ Client
- `grievance:update` - Grievance status update
- `grievance:new` - New grievance created (Admin only)
- `analytics:update` - Analytics data update (Admin only)

## Database Schema

The database includes the following main tables:
- `users` - User accounts (citizens and admins)
- `grievances` - Grievance records
- `timeline_events` - Status change timeline
- `admin_remarks` - Admin comments and remarks

See `database/schema.sql` for complete schema definition.

## Authentication

All protected routes require a JWT token in the Authorization header:
```
Authorization: Bearer <token>
```

Tokens are obtained from the login endpoint and expire after 1 day (configurable).

## Role-Based Access Control

- **Citizen**: Can create grievances and view their own grievances
- **Admin**: Full access to all grievances, can update status, assign handlers, and view analytics

## File Upload

Grievance images can be uploaded using multipart/form-data:
- Max file size: 5MB
- Allowed types: JPEG, JPG, PNG, WebP
- Files are stored in the `uploads/` directory

## Integration with Auth Service

This backend integrates with a separate authentication service. The auth service should be running on the port specified in `AUTH_SERVICE_URL` (default: `http://localhost:5000`).

The backend proxies authentication requests to the auth service while maintaining its own user table for extended user information.

## Error Handling

The API uses consistent error response format:
```json
{
  "success": false,
  "message": "Error message",
  "errors": [] // Optional validation errors
}
```

## Development

### Project Structure
```
backend/
â”œâ”€â”€ database/
â”‚   â””â”€â”€ schema.sql          # Database schema
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.js       # Configuration
â”‚   â”‚   â””â”€â”€ db.js           # Database connection
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ grievance.controller.js
â”‚   â”‚   â””â”€â”€ analytics.controller.js
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.middleware.js
â”‚   â”‚   â”œâ”€â”€ error.middleware.js
â”‚   â”‚   â””â”€â”€ upload.middleware.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ grievance.model.js
â”‚   â”‚   â””â”€â”€ analytics.model.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.routes.js
â”‚   â”‚   â”œâ”€â”€ grievance.routes.js
â”‚   â”‚   â””â”€â”€ analytics.routes.js
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ websocket.service.js
â”‚   â”œâ”€â”€ validators/
â”‚   â”‚   â””â”€â”€ grievance.validator.js
â”‚   â””â”€â”€ app.js              # Main application file
â”œâ”€â”€ uploads/                # Uploaded files directory
â”œâ”€â”€ .env                    # Environment variables
â”œâ”€â”€ .env.example            # Example environment variables
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## Testing

To test the API endpoints, you can use tools like:
- Postman
- cURL
- Thunder Client (VS Code extension)

Example request:
```bash
# Login
curl -X POST http://localhost:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'

# Create grievance (with token)
curl -X POST http://localhost:5001/api/grievances \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "category": "water-supply",
    "ward": "Naupada",
    "description": "Water supply issue in my area",
    "latitude": 19.2183,
    "longitude": 72.9781
  }'
```

## License

ISC

## Support

For issues and questions, please contact the development team.

