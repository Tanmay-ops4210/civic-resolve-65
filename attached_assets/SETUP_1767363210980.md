# Setup Guide for Civic Resolve Backend

This guide will help you set up the backend for the Civic Resolve application.

## Prerequisites

Before you begin, ensure you have the following installed:

- **Node.js** (v14 or higher) - [Download](https://nodejs.org/)
- **PostgreSQL** (v12 or higher) - [Download](https://www.postgresql.org/download/)
- **npm** (comes with Node.js)

## Step 1: Install Dependencies

```bash
npm install
```

## Step 2: Configure Environment Variables

1. Copy the example environment file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` with your configuration:
   ```env
   PORT=5001
   NODE_ENV=development
   
   DB_HOST=127.0.0.1
   DB_USER=postgres
   DB_PASSWORD=your_postgres_password
   DB_NAME=civic_resolve
   DB_PORT=5432
   
   JWT_SECRET=your_secure_secret_key_here
   JWT_EXPIRES_IN=1d
   
   AUTH_SERVICE_URL=http://localhost:5000
   
   UPLOAD_DIR=uploads
   MAX_FILE_SIZE=5242880
   
   CORS_ORIGIN=http://localhost:5173
   ```

## Step 3: Set Up PostgreSQL Database

### Option A: Using the Setup Script (Recommended)

```bash
npm run setup-db
```

This script will:
- Create the database if it doesn't exist
- Run the schema to create all tables, indexes, and triggers

### Option B: Manual Setup

1. Connect to PostgreSQL:
   ```bash
   psql -U postgres
   ```

2. Create the database:
   ```sql
   CREATE DATABASE civic_resolve;
   \q
   ```

3. Run the schema:
   ```bash
   psql -U postgres -d civic_resolve -f database/schema.sql
   ```

## Step 4: Create Uploads Directory

```bash
mkdir uploads
```

## Step 5: Start the Auth Service

Make sure your authentication service is running on port 5000 (or update `AUTH_SERVICE_URL` in `.env`).

The auth service should be available at: `http://localhost:5000`

## Step 6: Start the Backend Server

### Development Mode (with auto-reload):
```bash
npm run dev
```

### Production Mode:
```bash
npm start
```

The server will start on `http://localhost:5001` (or the port specified in `.env`).

## Step 7: Verify Installation

1. Check health endpoint:
   ```bash
   curl http://localhost:5001/health
   ```

   Expected response:
   ```json
   {
     "success": true,
     "message": "Server is running",
     "timestamp": "2024-01-01T00:00:00.000Z"
   }
   ```

2. Test authentication (make sure auth service is running):
   ```bash
   curl -X POST http://localhost:5001/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"berosgang@gmail.com","password":"TAM123888"}'
   ```

## Database Schema Overview

The database includes:

- **users** - User accounts (citizens and admins)
- **grievances** - Grievance/complaint records
- **timeline_events** - Status change history
- **admin_remarks** - Admin comments

All tables include proper indexes for optimal query performance.

## Default Admin User

The schema creates a default admin user:
- **Email**: `berosgang@gmail.com`
- **Password**: Should be set via the auth service

**Important**: Change the default password in production!

## Troubleshooting

### Database Connection Issues

1. Verify PostgreSQL is running:
   ```bash
   # On Windows
   pg_ctl status
   
   # On Linux/Mac
   sudo systemctl status postgresql
   ```

2. Check connection settings in `.env`

3. Verify database exists:
   ```bash
   psql -U postgres -l
   ```

### Port Already in Use

If port 5001 is already in use:
1. Change `PORT` in `.env`
2. Or stop the process using port 5001

### Auth Service Connection Issues

If you get errors connecting to the auth service:
1. Verify the auth service is running
2. Check `AUTH_SERVICE_URL` in `.env`
3. Ensure CORS is properly configured in the auth service

### File Upload Issues

1. Ensure `uploads/` directory exists and is writable
2. Check `MAX_FILE_SIZE` in `.env` (default: 5MB)
3. Verify file types are allowed (JPEG, JPG, PNG, WebP)

## Next Steps

1. **Frontend Integration**: Update your frontend API base URL to `http://localhost:5001`
2. **WebSocket**: Connect to WebSocket server at `http://localhost:5001` for real-time updates
3. **Testing**: Use Postman or similar tools to test all endpoints
4. **Production**: Update environment variables for production deployment

## API Documentation

See `README.md` for complete API documentation.

## Support

For issues or questions, please refer to the main README or contact the development team.

